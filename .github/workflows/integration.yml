name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  integration-tests:
    name: Integration Tests with SPIRE
    runs-on: ubuntu-latest

    # Service containers for SPIRE
    services:
      spire-server:
        image: ghcr.io/spiffe/spire-server:1.13.0
        ports:
          - 8081:8081
        options: >-
          --health-cmd="/opt/spire/bin/spire-server healthcheck"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'
          cache: true

      - name: Start SPIRE Agent
        run: |
          # Download SPIRE release
          wget https://github.com/spiffe/spire/releases/download/v1.13.0/spire-1.13.0-linux-amd64-musl.tar.gz
          tar xzf spire-1.13.0-linux-amd64-musl.tar.gz
          cd spire-1.13.0

          # Configure agent
          cat > conf/agent/agent.conf <<EOF
          agent {
              data_dir = "/tmp/spire-agent/data"
              log_level = "DEBUG"
              trust_domain = "example.org"
              server_address = "127.0.0.1"
              server_port = "8081"
              insecure_bootstrap = true
          }
          plugins {
              KeyManager "memory" { plugin_data {} }
              NodeAttestor "join_token" { plugin_data {} }
              WorkloadAttestor "unix" { plugin_data {} }
          }
          EOF

          # Start agent in background
          mkdir -p /tmp/spire-agent/public
          ./bin/spire-agent run -config conf/agent/agent.conf \
            -socketPath /tmp/spire-agent/public/api.sock &

          # Wait for agent socket
          timeout 30 bash -c 'until [ -S /tmp/spire-agent/public/api.sock ]; do sleep 1; done'

      - name: Run Integration Tests
        env:
          SPIFFE_ENDPOINT_SOCKET: unix:///tmp/spire-agent/public/api.sock
        run: |
          go test -v -tags=integration -timeout=5m ./...

      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage-integration.txt
          flags: integration
          name: integration-coverage

