name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  integration-tests:
    name: Integration Tests with SPIRE
    runs-on: ubuntu-latest

    # Note: SPIRE server is started in a step below, not as a service container
    # Service containers don't support volume mounts needed for config files

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: '1.25.3'
          cache: true

      - name: Download and setup SPIRE binaries
        run: |
          # Download SPIRE
          wget https://github.com/spiffe/spire/releases/download/v1.13.0/spire-1.13.0-linux-amd64-musl.tar.gz
          tar xzf spire-1.13.0-linux-amd64-musl.tar.gz

          # Make binaries available via environment variables for testhelpers
          echo "SPIRE_SERVER=$PWD/spire-1.13.0/bin/spire-server" >> $GITHUB_ENV
          echo "SPIRE_AGENT=$PWD/spire-1.13.0/bin/spire-agent" >> $GITHUB_ENV

          echo "SPIRE binaries available at:"
          echo "  Server: $PWD/spire-1.13.0/bin/spire-server"
          echo "  Agent: $PWD/spire-1.13.0/bin/spire-agent"

      - name: Run Integration Tests
        run: |
          go test -v -tags=integration -timeout=5m -coverprofile=coverage-integration.txt ./...

      - name: Upload test coverage
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        if: always()
        continue-on-error: true  # Don't fail workflow if codecov upload fails
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-integration.txt
          flags: integration
          name: integration-coverage

