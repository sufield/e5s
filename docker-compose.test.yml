# Docker Compose configuration for SPIRE integration testing
#
# This sets up a minimal SPIRE server and agent for running integration tests.
#
# Usage:
#   docker-compose -f docker-compose.test.yml up -d
#   go test -tags=integration -v ./...
#   docker-compose -f docker-compose.test.yml down

version: '3.8'

services:
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.13.0
    hostname: spire-server
    container_name: spire-server-test
    ports:
      - "8081:8081"
    volumes:
      - ./test/spire/server:/opt/spire/conf
      - spire-server-data:/opt/spire/data
    command: ["-config", "/opt/spire/conf/server.conf"]
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-server", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - spire-test

  spire-agent:
    image: ghcr.io/spiffe/spire-agent:1.13.0
    hostname: spire-agent
    container_name: spire-agent-test
    depends_on:
      spire-server:
        condition: service_healthy
    volumes:
      - ./test/spire/agent:/opt/spire/conf
      - spire-agent-socket:/tmp/spire-agent/public
    command: ["-config", "/opt/spire/conf/agent.conf"]
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-agent", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - spire-test

volumes:
  spire-server-data:
  spire-agent-socket:

networks:
  spire-test:
    driver: bridge
