# mtls-server.yaml - Development deployment for local testing
#
# This is the development/testing approach using kubectl cp to copy a locally-built binary.
# For production or demo use, see mtls-server-image.yaml instead.
#
# Prerequisites:
#   1. Build the server binary: go build -o bin/mtls-server ./examples/zeroconfig-example
#   2. Deploy SPIRE infrastructure: make minikube-up
#   3. Register workloads with SPIRE (see examples/README.md)
#
# Usage (quick copy/paste):
#   kubectl apply -f examples/mtls-server.yaml
#   POD=$(kubectl get pod -l app=mtls-server -o jsonpath='{.items[0].metadata.name}')
#   kubectl cp bin/mtls-server "$POD":/tmp/mtls-server
#   kubectl exec "$POD" -- chmod +x /tmp/mtls-server
#   kubectl exec -it "$POD" -- /tmp/mtls-server
#
# See examples/README.md for complete deployment guide

apiVersion: apps/v1
kind: Deployment
metadata:
  name: mtls-server
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mtls-server
  template:
    metadata:
      labels:
        app: mtls-server
    spec:
      # Pod-level security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534   # Standard Debian "nobody" user
        fsGroup: 65534     # Helps with socket access on hostPath
      # Disable service account token mounting (not needed for this demo)
      automountServiceAccountToken: false
      volumes:
        - name: spire-socket
          # If your SPIRE agent uses a different public socket directory, change this to match.
          # This path matches the default SPIRE Helm chart configuration.
          hostPath:
            path: /tmp/spire-agent/public
            type: Directory
      containers:
        - name: mtls-server
          image: debian:bookworm-slim
          command: ["sleep", "infinity"]  # Keep pod alive for binary copy
          # Container-level security context
          # NOTE: readOnlyRootFilesystem not set to allow kubectl cp to /tmp
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65534
            capabilities:
              drop:
                - ALL
          ports:
            - name: https
              containerPort: 8443
          volumeMounts:
            - name: spire-socket
              mountPath: /spire-socket
              readOnly: true
          # Optional: Environment variables (zero-config auto-detects these)
          # Can be omitted entirely to rely on autodetection.
          env:
            - name: SPIFFE_ENDPOINT_SOCKET
              value: "unix:///spire-socket/api.sock"
            - name: SERVER_ADDRESS
              value: ":8443"
          # Readiness probe: TCP check with longer delay to allow server startup
          # For more accurate readiness (verifying mTLS is working), use:
          #   exec:
          #     command: ["sh","-c","curl -sk https://localhost:8443/health | grep -q 'ok'"]
          readinessProbe:
            tcpSocket:
              port: 8443
            initialDelaySeconds: 5   # Increased from 2s to allow server startup
            periodSeconds: 5
          # Resource limits
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"   # Increase to 300m if throttling on small clusters
---
apiVersion: v1
kind: Service
metadata:
  name: mtls-server
  namespace: default
spec:
  selector:
    app: mtls-server
  ports:
    - name: https
      port: 8443
      targetPort: 8443
