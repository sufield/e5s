# Falco Custom Rules for SPIRE mTLS Runtime Security Monitoring
# ==============================================================
#
# ⚠️  DEPRECATION NOTICE ⚠️
# -------------------------
# This rules file is for BARE-METAL / DEVELOPMENT WORKSTATION installations only.
#
# For Kubernetes/Minikube deployments, use the Helm chart configuration:
#   - Rules are defined in: examples/minikube-lowlevel/infra/values-falco.yaml
#   - Enable with: ENABLE_FALCO=true helmfile -e dev apply
#
# The Helm chart uses a streamlined set of 5 critical rules optimized for
# Kubernetes environments. This file contains the full 18-rule set for
# bare-metal systemd installations.
#
# Documentation:
#   - Helm deployment: examples/minikube-lowlevel/infra/README.md
#   - Complete guide: security/FALCO_GUIDE.md
#   - Troubleshooting: security/BARE_METAL_TROUBLESHOOTING.md
#
# -------------------------
#
# This file contains Falco rules specifically designed for monitoring
# SPIRE-based mTLS applications at runtime. These rules detect:
#
# - Unauthorized access to SPIRE socket
# - Suspicious TLS/certificate operations
# - Unexpected file system modifications
# - Network anomalies in mTLS connections
# - Container escape attempts
# - Privilege escalation
#
# Usage (Bare-Metal Only):
#   1. Install Falco: sudo apt install -y falco
#   2. Copy this file: sudo cp security/falco_rules.yaml /etc/falco/falco_rules.local.yaml
#   3. Restart Falco: sudo systemctl restart falco
#   4. Monitor alerts: sudo journalctl -u falco -f
#
# Or use the automated setup script:
#   sudo bash security/setup-falco.sh
#
# SPIRE-specific context:
#   - SPIRE agent socket: /tmp/spire-agent/public/api.sock
#   - mTLS servers listen on port 8443
#   - Go binaries: mtls-server, test-client, zeroconfig-example

---
# ============================================================================
# SPIRE Workload API Security
# ============================================================================

- rule: Unauthorized Access to SPIRE Socket
  desc: Detect access to SPIRE Workload API socket by unauthorized processes
  condition: >
    evt.type in (open, openat) and
    fd.name contains "/tmp/spire-agent/public/api.sock" and
    not proc.name in (mtls-server, test-client, zeroconfig-example, spire-agent)
  output: >
    Unauthorized process accessing SPIRE socket
    (proc=%proc.name pid=%proc.pid user=%user.name file=%fd.name)
  priority: CRITICAL
  tags: [spire, security, unauthorized_access]

- rule: SPIRE Socket Permission Tampering
  desc: Detect attempts to modify SPIRE socket permissions
  condition: >
    evt.type in (chmod, fchmod) and
    fd.name contains "/tmp/spire-agent/public"
  output: >
    Attempt to modify SPIRE socket permissions
    (proc=%proc.name pid=%proc.pid user=%user.name file=%fd.name)
  priority: CRITICAL
  tags: [spire, tampering]

# ============================================================================
# mTLS Server Security
# ============================================================================

- rule: Unexpected Shell Spawned in mTLS Container
  desc: Detect shell execution inside mTLS server containers (potential compromise)
  condition: >
    spawned_process and
    container and
    container.image.repository in (mtls-server, ghcr.io/pocket/mtls-server) and
    proc.name in (bash, sh, dash, zsh, fish, csh, tcsh)
  output: >
    Shell spawned in mTLS server container
    (container=%container.name proc=%proc.name user=%user.name cmdline=%proc.cmdline)
  priority: WARNING
  tags: [container, shell, mtls]

- rule: Sensitive File Read by mTLS Process
  desc: Detect mTLS server reading sensitive system files
  condition: >
    evt.type in (open, openat) and
    evt.dir = < and
    fd.name in (/etc/shadow, /etc/passwd, /etc/sudoers, /root/.ssh/id_rsa) and
    proc.name in (mtls-server, zeroconfig-example)
  output: >
    mTLS process reading sensitive file
    (proc=%proc.name file=%fd.name user=%user.name)
  priority: CRITICAL
  tags: [mtls, sensitive_files]

- rule: Unexpected Network Port Binding
  desc: Detect mTLS server binding to unexpected ports (should only use 8443)
  condition: >
    evt.type = listen and
    proc.name in (mtls-server, zeroconfig-example) and
    fd.sport != 8443 and
    fd.sport != 0
  output: >
    mTLS server binding to unexpected port
    (proc=%proc.name port=%fd.sport expected=8443)
  priority: WARNING
  tags: [mtls, network]

# ============================================================================
# Certificate and TLS Operations
# ============================================================================

- rule: Certificate File Modification
  desc: Detect unauthorized modification of certificate files
  condition: >
    evt.type in (write, unlink, rename) and
    (fd.name glob "*.crt" or
     fd.name glob "*.pem" or
     fd.name glob "*.key" or
     fd.name contains "/etc/ssl/") and
    not proc.name in (openssl, spire-server, spire-agent, update-ca-certificates)
  output: >
    Certificate file modified by unexpected process
    (proc=%proc.name file=%fd.name user=%user.name)
  priority: CRITICAL
  tags: [certificates, tampering]

- rule: TLS Downgrade Attempt
  desc: Detect potential TLS version downgrade attacks
  condition: >
    evt.type = accept and
    fd.type = ipv4 and
    fd.sport = 8443 and
    proc.name in (mtls-server, zeroconfig-example)
  output: >
    TLS connection accepted on mTLS port
    (proc=%proc.name client_ip=%fd.cip client_port=%fd.cport server_ip=%fd.sip server_port=%fd.sport)
  priority: INFO
  tags: [tls, network, monitoring]

# ============================================================================
# Container Security
# ============================================================================

- rule: Container Escape Attempt via Proc
  desc: Detect container escape attempts via /proc manipulation
  condition: >
    container and
    (evt.type = open or evt.type = openat) and
    (fd.name glob "/proc/*/root/*" or
     fd.name glob "/proc/*/cwd/*" or
     fd.name = "/proc/sys/kernel/core_pattern") and
    not proc.pname in (dockerd, containerd, runc)
  output: >
    Potential container escape attempt
    (container=%container.name proc=%proc.name file=%fd.name)
  priority: CRITICAL
  tags: [container, escape, security]

- rule: Privileged Container with CAP_SYS_ADMIN
  desc: Detect privileged containers that could break out
  condition: >
    spawned_process and
    container and
    (container.privileged = true or
     thread.cap_permitted contains "cap_sys_admin")
  output: >
    Privileged container detected
    (container=%container.name image=%container.image proc=%proc.name caps=%thread.cap_permitted)
  priority: WARNING
  tags: [container, privileged]

- rule: Unexpected File Write in Container Root
  desc: Detect writes to container root filesystem (should use volumes)
  condition: >
    container and
    evt.type in (write, creat, mkdir) and
    fd.name startswith "/" and
    not fd.name startswith "/tmp" and
    not fd.name startswith "/var" and
    not fd.name startswith "/spire-socket" and
    proc.name in (mtls-server, test-client, zeroconfig-example)
  output: >
    Unexpected file write in container root
    (container=%container.name proc=%proc.name file=%fd.name)
  priority: NOTICE
  tags: [container, filesystem]

# ============================================================================
# Go Runtime Security
# ============================================================================

- rule: Go Binary Executing System Commands
  desc: Detect Go binaries spawning unexpected child processes
  condition: >
    spawned_process and
    proc.pname in (mtls-server, test-client, zeroconfig-example) and
    not proc.name in (mtls-server, test-client, zeroconfig-example)
  output: >
    Go binary spawned unexpected process
    (parent=%proc.pname child=%proc.name cmdline=%proc.cmdline user=%user.name)
  priority: WARNING
  tags: [go, process]

- rule: Go Binary Memory Dump Attempt
  desc: Detect attempts to dump Go process memory
  condition: >
    evt.type = ptrace and
    proc.name in (gdb, strace, gcore) and
    evt.arg.request contains PTRACE_ATTACH
  output: >
    Attempt to attach debugger to running process
    (debugger=%proc.name target=%evt.arg.pid user=%user.name)
  priority: WARNING
  tags: [go, debug, security]

# ============================================================================
# Network Security
# ============================================================================

- rule: Outbound Connection from mTLS Server
  desc: Detect unexpected outbound connections (mTLS servers should be inbound-only)
  condition: >
    evt.type = connect and
    evt.dir = > and
    fd.type = ipv4 and
    proc.name in (mtls-server, zeroconfig-example) and
    not fd.sip = 127.0.0.1 and
    fd.sport != 53
  output: >
    Unexpected outbound connection from mTLS server
    (proc=%proc.name dest=%fd.sip:%fd.sport src=%fd.cip:%fd.cport)
  priority: NOTICE
  tags: [network, mtls, outbound]

- rule: Non-TLS Connection on mTLS Port
  desc: Detect non-encrypted connections on TLS port (potential cleartext attack)
  condition: >
    evt.type = accept and
    fd.sport = 8443 and
    evt.buffer contains "GET " and
    not evt.buffer contains "HTTPS"
  output: >
    Non-TLS connection attempt on mTLS port
    (proc=%proc.name client_ip=%fd.cip client_port=%fd.cport)
  priority: CRITICAL
  tags: [tls, cleartext, attack]

# ============================================================================
# Kubernetes/Minikube Security
# ============================================================================

- rule: Unauthorized Service Account Token Access
  desc: Detect access to Kubernetes service account tokens
  condition: >
    evt.type in (open, openat) and
    fd.name contains "/var/run/secrets/kubernetes.io/serviceaccount/token" and
    container.image.repository in (mtls-server, test-client)
  output: >
    Service account token accessed
    (container=%container.name proc=%proc.name file=%fd.name)
  priority: WARNING
  tags: [kubernetes, serviceaccount]
  # Note: This rule may fire if automountServiceAccountToken=true

- rule: ConfigMap or Secret Modification
  desc: Detect modification of mounted ConfigMaps or Secrets
  condition: >
    container and
    evt.type in (write, unlink, rename) and
    (fd.name startswith "/etc/config" or fd.name startswith "/etc/secret")
  output: >
    Mounted config/secret modified
    (container=%container.name proc=%proc.name file=%fd.name)
  priority: CRITICAL
  tags: [kubernetes, config, tampering]

# ============================================================================
# False Positive Tuning
# ============================================================================

# The following exceptions reduce noise from legitimate operations:

- list: allowed_spire_processes
  items: [spire-agent, spire-server, mtls-server, test-client, zeroconfig-example]

- list: trusted_images
  items: [
    golang,
    gcr.io/distroless/static-debian12,
    ghcr.io/pocket/mtls-server,
    debian:bookworm-slim
  ]

- macro: container_is_trusted
  condition: container.image.repository in (trusted_images)

# ============================================================================
# Monitoring and Observability
# ============================================================================

- rule: High Rate of Failed TLS Handshakes
  desc: Detect potential DoS or scanning activity
  condition: >
    evt.type = accept and
    fd.sport = 8443
  output: >
    TLS connection attempt
    (proc=%proc.name client_ip=%fd.cip client_port=%fd.cport rate_limit=10s)
  priority: INFO
  tags: [monitoring, tls]
  # Note: Use Falco's rate limiting feature to detect bursts

- rule: SPIRE Agent Restart
  desc: Monitor SPIRE agent restarts for availability tracking
  condition: >
    spawned_process and
    proc.name = spire-agent
  output: >
    SPIRE agent started
    (proc=%proc.name pid=%proc.pid cmdline=%proc.cmdline)
  priority: INFO
  tags: [spire, monitoring]

# ============================================================================
# Usage Notes
# ============================================================================
#
# Testing rules:
#   1. Trigger unauthorized socket access:
#      cat /tmp/spire-agent/public/api.sock
#
#   2. Spawn shell in container:
#      kubectl exec -it mtls-server-xxx -- bash
#
#   3. Bind to wrong port (modify code):
#      Change SERVER_ADDRESS to :9000
#
#   4. Read sensitive file:
#      cat /etc/shadow (from mtls-server process)
#
# Viewing alerts:
#   - Journalctl: sudo journalctl -u falco -f
#   - Syslog: tail -f /var/log/falco.log
#   - JSON output: Configure json_output: true in /etc/falco/falco.yaml
#
# Integration with SIEM:
#   - Configure http_output in falco.yaml for Falcosidekick
#   - Send to Slack, PagerDuty, or Elasticsearch
#   - Use GitHub Actions to check for critical alerts in CI/CD
