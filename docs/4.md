I’ll flag correctness first, then portability/security, then small DX upgrades. I include drop-in fixes.

* Approach is solid: compile locally, run in a pod that mounts the SPIRE UDS.
* The **Debian runner** is great for iteration.
* The **distroless runner** is the right CI shape (initContainer + copy).

---

## Script 1: “Optimized” (Debian)

### ✅ Correct

* Tolerant agent label lookup.
* Waits for `PodScheduled` then `Ready` (pod runs `sleep infinity`) → OK.
* Copies only the test binary and executes it.
* Auto-detects `GOARCH` from the node.

### ⚠️ Fixes

1. **Minikube-only socket check**
   You hard-require `minikube ssh`. In generic clusters that breaks. Also your `test -S … -o -d …` may be shell-dependent.

**Use agent pod or make Minikube check optional:**

```bash
# Prefer checking inside the agent pod (works everywhere)
if ! kubectl exec -n "$NS" "$AGENT_POD" -- test -S /tmp/spire-agent/public/api.sock; then
  error "Workload API socket not visible inside SPIRE Agent pod"
  exit 1
fi
# If you still want a node check in Minikube environments:
if command -v minikube >/dev/null 2>&1; then
  minikube ssh -- "test -S ${SOCKET_DIR}/${SOCKET_FILE} || test -d ${SOCKET_DIR}" >/dev/null 2>&1 \
    || { error "Socket/dir missing on node: ${SOCKET_DIR}/${SOCKET_FILE}"; exit 1; }
fi
```

2. **Static binary for safety**
   If any CGO sneaks in, the binary may fail in the container. Build statically by default.

```bash
CGO_ENABLED=0 GOOS=linux GOARCH="$GOARCH" \
  go test -tags="$TAGS" -c -o "$TESTBIN" "$PKG"
```

3. **Node scheduling (multi-node)**
   `hostPath` requires the pod land on a node that actually has the socket. For Minikube (single node) you’re fine; in multi-node, add an optional nodeSelector.

```yaml
# Add under spec: (only if you know the node)
# nodeName: <node-with-agent-socket>
```

4. **Timeout the test run**
   Avoid hung jobs:

```bash
kubectl exec -n "$NS" "$POD_NAME" -- /work/integration.test -test.v -test.timeout=3m
```

5. **Security context (non-root)**
   Keep dev-friendly but safer:

```yaml
securityContext:
  runAsNonRoot: true
  allowPrivilegeEscalation: false
```

---

## Script 2: “CI / Distroless” (initContainer)

### ✅ Correct

* Uses `CGO_ENABLED=0` and `distroless:nonroot`.
* Always copies into an **initContainer** (BusyBox) → avoids `kubectl cp`/tar issues.
* Streams logs and extracts terminated exit code from the `test` container.
* Non-root + seccomp + drop caps → good hardening.

### ⚠️ Fixes

1. **Minikube-only socket check**
   Same as above: make Minikube check optional and prefer agent pod check:

```bash
kubectl exec -n "$NS" "$AGENT_POD" -- test -S /tmp/spire-agent/public/api.sock \
  || { error "Workload API socket not visible inside Agent pod"; exit 1; }
```

2. **Race on exitCode**
   If logs return early, the container state may not be populated yet. Add a small wait/retry:

```bash
for i in {1..10}; do
  EXIT_CODE="$(kubectl get pod -n "$NS" "$POD_NAME" \
    -o jsonpath='{.status.containerStatuses[?(@.name=="test")].state.terminated.exitCode}' 2>/dev/null || true)"
  [ -n "$EXIT_CODE" ] && break
  sleep 0.5
done
[ -z "$EXIT_CODE" ] && EXIT_CODE=1
```

3. **Cross-arch consistency**
   You already pick `GOARCH` from the node; keep that (good).

4. **Test timeout**
   Make it explicit:

```yaml
args: ["-test.v", "-test.timeout=3m"]
```

---

## Small DX upgrades (both)

* **Parametrize test flags:**
  Allow overrides from CI: `TEST_FLAGS="${TEST_FLAGS:--test.v -test.timeout=3m}"` and pass them to the binary.
* **Surface failure context:**
  On failure, `kubectl describe pod` and `kubectl logs -p` (previous) help with crash loops.
* **Keep pod flag (distroless)**
  Add `KEEP=true` support to inspect artifacts after failures.

---

## Minimal patch set

### Replace Minikube-only check

```bash
# BEFORE
if ! minikube ssh -- "test -S ${SOCKET_DIR}/${SOCKET_FILE} -o -d ${SOCKET_DIR}" >/dev/null 2>&1; then

# AFTER
if ! kubectl exec -n "$NS" "$AGENT_POD" -- test -S /tmp/spire-agent/public/api.sock; then
  error "Workload API socket not visible inside SPIRE Agent pod"
  exit 1
fi
# (optional) Node check if minikube present:
if command -v minikube >/dev/null 2>&1; then
  minikube ssh -- "test -S ${SOCKET_DIR}/${SOCKET_FILE} || test -d ${SOCKET_DIR}" >/dev/null 2>&1 || {
    error "Socket/dir missing on node: ${SOCKET_DIR}/${SOCKET_FILE}"
    exit 1
  }
fi
```

### Force static binary in both

```bash
CGO_ENABLED=0 GOOS=linux GOARCH="$GOARCH" \
  go test -tags="$TAGS" -c -o "$TESTBIN" "$PKG"
```

### Add test timeout

```bash
# Debian runner
kubectl exec -n "$NS" "$POD_NAME" -- /work/integration.test -test.v -test.timeout=3m
# Distroless YAML
args: ["-test.v", "-test.timeout=3m"]
```

---

* Prefer **agent-pod socket check**; make Minikube SSH check optional.
* Build **static** test binaries for both paths.
* Distroless flow is correct—always use an **initContainer** when copying in.
* Add **timeouts** and (optionally) a **node pin** for multi-node clusters.
