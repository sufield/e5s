## ❗Inconsistencies / Corrections

1. ### Registry sealing (sealed vs not sealed)

* You say “registry is sealed after bootstrap” **and** “registry is returned already seeded (but not sealed in current impl)”.
* **Pick one** and make it true in code & doc. Recommended:

  * Seal inside the factory after seeding (deterministic, least surprise).
  * Update doc to: “Factory returns **seeded and sealed** registry; no mutation afterward.”

2. ### Error types moved from domain → ports

* Earlier diffs moved infra errors to `internal/ports/errors.go` (`ports.ErrServerUnavailable`, `ports.ErrAgentUnavailable`, `ports.ErrCANotInitialized`).
* In this doc, the **IdentityServer** error contract still references **domain.ErrServerUnavailable** and **domain.ErrCANotInitialized**.
* **Fix**: change to `ports.ErrServerUnavailable` / `ports.ErrCANotInitialized` everywhere in dev adapter docs and comments.

3. ### Selector format typo

* In **WorkloadAttestor** you state: “Selectors must be formatted as `type::value`”.
* Everywhere else (and in code) it’s `type:key:value` and value may contain additional colons.
* **Fix**: change to `type:key:value` (e.g., `unix:uid:1000`).

4. ### InMemoryServer struct typo / wrong type

* Shown as:

  ```go
  ca               *rsa.Private
  ```

  That type doesn’t exist and the field name is inconsistent with code elsewhere.
* **Fix**:

  ```go
  caKey *rsa.PrivateKey
  ```

  and keep the name consistent across the repo/docs.

5. ### GetCA vs GetCACertPEM

* One section claims: “GetTrustDomain() and **GetCA()** are read-only”, but the port exposes `GetCACertPEM()`, not `GetCA()`.
* **Fix**: replace references to `GetCA()` with `GetCACertPEM()`; if you truly need `GetCA()` (returns *x509.Certificate), add it to the port and adapter.

6. ### IdentityDocument TODO alignment

* You note a TODO to remove `privateKey` from the domain entity. That’s good, but:

  * Ensure **all** places that construct/validate `IdentityDocument` are documented to take `(doc, signer)` separation or move signing to adapters only.
  * Until the refactor lands, keep the docs consistent with current signatures.

7. ### Factory sealing statement vs. code snippet

* The `CreateRegistry` snippet returns a non-sealed registry and comments say “NOT sealed yet in current impl”.
* If you adopt item (1), update the snippet to:

  ```go
  registry.Seal()
  return registry, nil
  ```

  and remove “NOT sealed yet”.

8. ### “Deterministic CA generation” details

* You mention fixed time/seed (“2099-01-01” / seeded RNG). That’s fine, but ensure:

  * Serial numbers remain unique per issued cert (even with deterministic CA) to avoid chain validation edge cases.
  * If not implemented, either document that it’s pseudo-deterministic only for the CA **key/cert**, not per-leaf, or switch to time/nonce-based serials for leaves.

9. ### Paths / names correctness

* A few path references look fine, but remove line numbers entirely (you already started doing this in the diff) and make sure filenames match actual code:

  * `internal/adapters/outbound/inmemory/registry.go` (Seed/Seal)
  * `internal/adapters/outbound/compose/inmemory.go` (factory)
  * `internal/app/bootstrap_dev.go` (uses factory; does **not** seed itself)

10. ### Bootstrap timeout claim

* You claim a default 10s timeout guard in `bootstrap_dev.go`. Ensure the code actually wraps the provided context if it’s `nil` or has no deadline. If absent, either implement it or remove the claim.

11. ### WorkloadAttestor examples

* You validate selector strings via `domain.ParseSelectorFromString`. Make sure example selectors you show (`unix:uid:1001`) align with the current `Selector` constructor rules (type/key no colons; value may contain colons).

12. ### “What is NOT Control Plane”

* You state no `workloadapi` inbound/outbound adapters; but you **do** have an outbound SPIRE adapter in production (`internal/adapters/outbound/spire`). Clarify:

  * “In dev mode, there is no `workloadapi` adapter. In production, the outbound SPIRE adapter uses Workload API.”

## Suggested wording fixes (drop-in)

* **Registry sealing** (in Overview / Components):

  > The registry is **seeded and sealed inside the factory**. After `CreateRegistry(...)` returns, the registry is immutable; the port exposes only read methods.

* **IdentityServer error contract**:

  > * IssueIdentity: `domain.ErrIdentityDocumentInvalid` if the credential is invalid
  > * IssueIdentity: `ports.ErrServerUnavailable` if the server is unavailable
  > * IssueIdentity: `ports.ErrCANotInitialized` if the CA is not initialized

* **WorkloadAttestor selector format**:

  > Selectors must be formatted as `type:key:value` (e.g., `unix:uid:1000`, `k8s:namespace:prod`).

* **InMemoryServer struct**:

  ```go
  type InMemoryServer struct {
      trustDomain         *domain.TrustDomain
      caCert              *x509.Certificate
      caKey               *rsa.PrivateKey
      certificateProvider ports.IdentityDocumentProvider
  }
  ```

* **GetCA reference**:

  > Read-only accessors: `GetTrustDomain()`, `GetCACertPEM()`.

Conceptually correct and cleanly aligned with hexagonal boundaries. After fixing the handful of inconsistencies (error types, selector format, sealing point, method/type names), the doc will accurately reflect the implementation and reduce confusion for contributors.
