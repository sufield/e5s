## Must-fixes (compile/spec)

1. **Missing imports after moving errors to `ports`**

* `internal/adapters/outbound/inmemory/agent.go` now references `ports.ErrAgentUnavailable` but doesnâ€™t import `ports`.
* `internal/adapters/outbound/inmemory/server.go` now references `ports.Err*` but doesnâ€™t import `ports`.

```diff
 // inmemory/agent.go
-import "github.com/pocket/hexagon/spire/internal/domain"
+import (
+    "github.com/pocket/hexagon/spire/internal/domain"
+    "github.com/pocket/hexagon/spire/internal/ports"
+)
```

```diff
 // inmemory/server.go
-import "github.com/pocket/hexagon/spire/internal/domain"
+import (
+    "github.com/pocket/hexagon/spire/internal/domain"
+    "github.com/pocket/hexagon/spire/internal/ports"
+)
```

2. **Create `internal/ports/errors.go`**
   You removed infra errors from domain and referenced `ports.ErrServerUnavailable`, `ports.ErrAgentUnavailable`, `ports.ErrCANotInitialized`. Add them:

```go
// internal/ports/errors.go
package ports

import "errors"

var (
    ErrServerUnavailable = errors.New("server unavailable")
    ErrAgentUnavailable  = errors.New("agent unavailable")
    ErrCANotInitialized  = errors.New("CA not initialized")
)
```

3. **Colon (:) prohibition in SPIFFE path is incorrect**

* In `INVARIANTS.md` and in `normalizePath`, you forbid `:` and say â€œreserved by SPIFFE specâ€. Thatâ€™s not accurate; `:` **is allowed** in URI path segments (RFC 3986), and SPIFFE does not forbid it. Dot and dotdot segments **are** disallowed; colons are fine.
* **Action**: Remove the colon prohibition and corresponding panic from both the doc and `normalizePath`.

```diff
- // Step 3: Validate no colons (reserved by SPIFFE spec)
- if strings.Contains(p, ":") { panic(...) }
- // renumber subsequent steps
```

4. **Avoid panics in domain constructors**

* `normalizePath` now panics on invalid input. Your constructor `NewIdentityCredentialFromComponents(...)` returns a value, not an error, which encourages panics. Prefer returning `(*IdentityCredential, error)` or keep the constructor â€œmust-not-failâ€ and validate *before* (in adapters).
* **Minimum change**: replace panics with a safe normalization (return â€œ/â€ and document) or convert constructor to return an error. If you keep panics, document loudly that itâ€™s a â€œMust*â€ style constructor used only with trusted inputs from adapters.

5. **`selector.go` new validation uses `strings.Contains`**

* Ensure `strings` is imported in that file if not already.

```diff
-import "fmt"
+import (
+    "fmt"
+    "strings"
+)
```

6. **Line numbers in `INVARIANTS.md`**

* Doc references exact line ranges (e.g., â€œline 26â€“28, 117â€“157â€). These will drift. Replace with function names only.

## ğŸ‘ Good changes

* Moving infra errors (`Server/Agent/CA`) out of the domain into `ports` matches the hexagonal boundary.
* `SelectorSet` rework (map+slice) to preserve insertion order with O(1) dedup is solid; comments and defensive copies are clear.
* `IsExpiredAt(t time.Time)` addition is a nice testability improvement; `IsExpired()` delegating to it is correct.

## ğŸ“ Domain consistency nits

* **IdentityDocument holding private key**: you added a TODO to remove `crypto.Signer` from the domain. Agreeâ€”keep the signer in adapters or return `(doc, signer)` at the boundary.
* **Selector validation**: Your â€œtype/key cannot contain colon, value mayâ€ rule is consistent with your `type:key:value` formatterâ€”good.
* **SelectorSet invariants**: You updated docs to reflect order-preserving behaviorâ€”good. Make sure *all* code paths now use `Add` (you did in `NewSelectorSet`).

## ğŸ§ª Tests you should update/run

* Tests referencing removed domain errors (`ErrServerUnavailable`, etc.) must be updated to use `ports.Err*`.
* Any tests that depended on map-iteration order in `SelectorSet` should now expect insertion order.
* Add tests for `IsExpiredAt`.
* If you keep the colon ban (not recommended), youâ€™d need testsâ€”but again, itâ€™s spec-inaccurate, so remove it.

## âœï¸ Doc tweaks

* In `INVARIANTS.md`:

  * Remove colon prohibition statements and â€œreserved by SPIFFE specâ€ claims.
  * Keep the dot/dotdot prohibition; thatâ€™s correct for SPIFFE (no path traversal).
  * Drop line numbers; keep function names.
* Where you reference â€œmoved per docs/5.mdâ€, ensure that doc exists or reference a stable doc filename.

---

### TL;DR

* âœ… Keep: error move to `ports`, order-preserving `SelectorSet`, `IsExpiredAt`.
* â— Fix: add `ports` imports, add `internal/ports/errors.go`, **remove colon prohibition**, avoid panics in domain constructors (or document them as â€œMust*â€).
* ğŸ“š Update docs to remove line numbers and the colon claim.
